# Release Notes & Test Plan ‚Äî January 29-30, 2026

## Summary of Changes

### 1. Large-Scale Catalog Import with Auto-Enrichment
**What changed:** Uploading an Excel/CSV file now automatically enriches products with Keepa data (titles, images, categories) in the background.

**Details:**
- New `process-enrichment-job-background` Netlify Background Function (15-min timeout)
- New `enrichment_jobs` database table tracks progress
- Real-time progress bar shows enrichment status (processed/enriched/failed/tokens)
- Batches of 100 ASINs, 3 concurrent batches
- Fire-and-forget architecture ‚Äî UI never blocks

### 2. Catalog Import ‚Üí CRM Integration
**What changed:** Importing a catalog file now auto-creates `sourced_products` (CRM) records with "Imported" status.

**Details:**
- New system status "Imported" added to `crm_statuses`
- Products appear in Product CRM immediately after import
- Enriched data (title, image) syncs to both `catalog_imports` and `sourced_products`
- Existing ASINs are not duplicated

### 3. Contact Source Cleanup
**What changed:** Removed unused contact sources, added new one.

**Details:**
- **Removed:** Direct Contact, Facebook Group, Referral, Trade Show
- **Added:** Creator Connections
- **Remaining:** Creator Connections, Instagram (UAT) / + Email, Viral Vue (Prod)

### 4. Delete Button on Active Upload Tasks
**What changed:** Users can now delete active (pending) upload tasks, not just completed ones.

**Details:**
- Trash icon button added next to "Done" button
- Confirmation dialog before delete ("Delete this task?")
- Hard delete from `influencer_tasks` table
- Chrome extension won't show deleted tasks (they're removed from DB)

### 5. Auto-Thumbnail Generation Fix
**What changed:** Fixed thumbnail auto-generation when assigning an owner to a product.

**Details:**
- Frontend now sends `{ asin, ownerId }` instead of `{ product_id, owner_id }` (was mismatched with backend API)
- Backend now looks up product image from `sourced_products` instead of guessing Amazon image URLs
- Database trigger installed: auto-fires thumbnail generation when new `influencer_tasks` are created
- Uses `pg_net` extension for async HTTP webhook calls

### 6. Database Constraint Fix (Prod)
**What changed:** Removed restrictive `catalog_imports_status_check` constraint that blocked imports on production.

**Details:**
- Old constraint only allowed: `imported`, `processed`, `reviewed`
- Code also uses `skipped` status ‚Äî constraint dropped to match UAT

---

## Test Plan for Manual Testers

### Environment
- **UAT:** https://uat.opsyncpro.io
- **Production:** https://opsyncpro.io
- **Login credentials:** Use your standard test account

---

### Test Suite 1: Catalog Import & Enrichment

#### TC-1.1: Basic Import (Happy Path)
**Steps:**
1. Navigate to ASIN Catalog ‚Üí Catalog Import
2. Click "Import from File"
3. Upload an Excel file with 3-5 ASINs in column A (header: "ASIN")
4. Confirm the import

**Expected:**
- [ ] File parses without errors
- [ ] ASINs appear in the catalog list immediately
- [ ] Enrichment progress bar appears showing real-time progress
- [ ] Within 60 seconds: titles populated (not "Title pending...")
- [ ] Within 60 seconds: images appear (not placeholder)
- [ ] Progress bar shows "Complete!" then disappears after ~3 seconds
- [ ] No console errors (F12 ‚Üí Console)

#### TC-1.2: Large File Import (Performance)
**Steps:**
1. Upload an Excel file with 100+ ASINs
2. Watch the progress bar

**Expected:**
- [ ] Import completes without timeout
- [ ] Progress bar updates in real-time (processed count increments)
- [ ] Enriched count matches total (minus any unavailable ASINs)
- [ ] Page remains responsive during enrichment
- [ ] No black screen after import

#### TC-1.3: Duplicate ASIN Handling
**Steps:**
1. Import a file with 3 ASINs
2. Import the same file again

**Expected:**
- [ ] Second import shows "skipped" count for existing ASINs
- [ ] No duplicate records in catalog
- [ ] No duplicate records in Product CRM

#### TC-1.4: Screen After Import
**Steps:**
1. Import any file
2. Observe the page immediately after import completes

**Expected:**
- [ ] Page does NOT go black/blank
- [ ] Catalog list is visible and populated
- [ ] Navigation still works

#### TC-1.5: Invalid File
**Steps:**
1. Try uploading a non-Excel file (e.g., .txt, .pdf)
2. Try uploading an Excel file with no ASIN column

**Expected:**
- [ ] Appropriate error message displayed
- [ ] No crash or black screen

---

### Test Suite 2: Product CRM Integration

#### TC-2.1: Imported Products Appear in CRM
**Steps:**
1. Import a file via Catalog Import
2. Navigate to Product CRM

**Expected:**
- [ ] Imported products appear in the CRM list
- [ ] Status shows "Imported"
- [ ] Title and image are populated (after enrichment)

#### TC-2.2: Status Filter Includes Imported
**Steps:**
1. Open Product CRM
2. Check the status filter dropdown

**Expected:**
- [ ] "Imported" is listed as a status option
- [ ] Products with "Imported" status are visible by default

#### TC-2.3: Contact Source Dropdown
**Steps:**
1. Open any product in Product CRM
2. Click the Contact Source dropdown

**Expected:**
- [ ] "Creator Connections" appears as an option
- [ ] "Instagram" appears as an option
- [ ] "Direct Contact", "Facebook Group", "Referral", "Trade Show" do NOT appear

---

### Test Suite 3: Upload Task Delete

#### TC-3.1: Delete Active Task
**Steps:**
1. Navigate to Upload Tasks
2. Find any active (pending) task
3. Click the trash icon (üóëÔ∏è) next to "Done"

**Expected:**
- [ ] Confirmation dialog: "Delete this task?"
- [ ] Click OK ‚Üí task disappears from list
- [ ] Task count updates
- [ ] Task does not reappear on refresh

#### TC-3.2: Cancel Delete
**Steps:**
1. Click trash icon on an active task
2. Click "Cancel" on the confirmation dialog

**Expected:**
- [ ] Task remains in the list
- [ ] No changes made

#### TC-3.3: Delete Reflected in Chrome Extension
**Steps:**
1. Open Chrome extension sidebar
2. Note a specific task
3. Delete that task from the web UI
4. Refresh the Chrome extension

**Expected:**
- [ ] Deleted task no longer appears in the extension

---

### Test Suite 4: Auto-Thumbnail Generation

#### TC-4.1: Thumbnail on Owner Assignment
**Steps:**
1. Open Product CRM
2. Find a product WITH an image but WITHOUT a thumbnail
3. Assign an owner (Peter or Jaimie)
4. Wait 10-15 seconds

**Expected:**
- [ ] Thumbnail auto-generates
- [ ] Thumbnail shows the product image composited on the owner's template
- [ ] No manual action needed

#### TC-4.2: Thumbnail for Product Without Image
**Steps:**
1. Find a product with no image_url
2. Assign an owner

**Expected:**
- [ ] Graceful failure ‚Äî no crash
- [ ] Console may show "Product image not found" (expected)
- [ ] No thumbnail generated (expected)

#### TC-4.3: Multiple Owner Assignment
**Steps:**
1. Select multiple products (bulk select)
2. Assign an owner to all

**Expected:**
- [ ] Thumbnails generate for each product
- [ ] No timeout or error

---

### Test Suite 5: Edge Cases

#### TC-5.1: Import While Enrichment Running
**Steps:**
1. Import a large file (50+ ASINs)
2. While enrichment is in progress, import another small file

**Expected:**
- [ ] Second import creates a separate enrichment job
- [ ] Progress bar switches to the new job OR shows both
- [ ] No data corruption

#### TC-5.2: Navigate Away During Enrichment
**Steps:**
1. Import a file and see enrichment start
2. Navigate to a different page
3. Come back to Catalog Import

**Expected:**
- [ ] Enrichment continues in the background
- [ ] Products are enriched when you return
- [ ] Progress bar may not show (expected ‚Äî it's session-based)

#### TC-5.3: Import with Mixed Valid/Invalid ASINs
**Steps:**
1. Create an Excel file with:
   - Valid ASINs (e.g., B07BY3HJPT)
   - Invalid strings (e.g., "NOTANASIN", "12345")
   - Empty rows

**Expected:**
- [ ] Valid ASINs imported successfully
- [ ] Invalid ASINs rejected with clear messaging
- [ ] Empty rows ignored

#### TC-5.4: Enrichment of Nonexistent ASIN
**Steps:**
1. Import a file with a fabricated ASIN (e.g., B9999999ZZ)

**Expected:**
- [ ] Import succeeds (ASIN is stored)
- [ ] Enrichment marks it as "unavailable" (not "enriched")
- [ ] Failed count increments in progress bar
- [ ] No crash

#### TC-5.5: Rapid Owner Re-assignment
**Steps:**
1. Assign owner "Peter" to a product
2. Immediately change to "Jaimie"

**Expected:**
- [ ] Both thumbnail generations fire
- [ ] Final thumbnail uses Jaimie's template
- [ ] No errors or duplicates

---

## Known Limitations

1. **Progress bar is session-based** ‚Äî if you navigate away and come back, the progress bar won't resume (enrichment still runs in background)
2. **Enrichment worker timeout** ‚Äî Netlify Background Functions have a 15-minute limit. Files with 5,000+ ASINs may need multiple runs.
3. **Keepa API tokens** ‚Äî each ASIN costs 1 Keepa token. Large imports consume tokens proportionally.
4. **Thumbnail templates required** ‚Äî auto-thumbnail only works for owners that have a template configured (currently Peter and Jaimie)

---

## Rollback Plan

If critical issues found:
1. **Code:** Revert to commit `c62cbe4` (pre-changes) on `main` branch
2. **Database:** 
   - `enrichment_jobs` table can be dropped without impact
   - `enrichment_status` column can be dropped
   - `app_config` table can be dropped
   - Trigger can be removed: `DROP TRIGGER influencer_tasks_auto_thumbnail ON influencer_tasks`
3. **Contact sources:** Re-add removed sources via SQL if needed
